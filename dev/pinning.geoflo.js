/*!
 * /*!
 *  * GeoFlo SDK
 *  * Version 1.1.7
 *  * Generated on: 2025-02-07T01:35:26.289Z
 *  * /
 */
"use strict";
(self["webpackChunk_solutegrate_geoflo"] = self["webpackChunk_solutegrate_geoflo"] || []).push([["pinning"],{

/***/ "./src/Pinning.js":
/*!************************!*\
  !*** ./src/Pinning.js ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/**
 * @mixin
 * @memberof module:geoflo
 * @name Pinning
 * @description This module provides the pinning functionality for the Geoflo application. It allows users to pin features to the map by creating a buffer around the feature and snapping to nearby features.
 * @param {Object} mode - The mode object containing the type of mode.
 * @returns {Object} Returns the Pinning object.
 */
var Pinning = function Pinning(mode) {
  var geoflo = this.geoflo;
  this.type = mode.type;
  this.coldFeatures = [];
  this.pinableFeatures = [];
  this.pinnedFeatures = [];

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name activate
   * @description Activates the feature by setting the enabled flag to true and enabling pinning in the options.
   * @params {void} None
   * @returns {void}
   */
  /**
  * @function activate
  * @memberof _MEMBER_OF_
  * @description - This function activates the pinning functionality by setting the enabled flag to true and enabling pinning in the options.
  *
  * @returns {void} No return value.
  *
  */
  this.activate = function () {
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
    this.enabled = true;
    geoflo.options['pinning'].enable = true;
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name deactivate
   * @description This function deactivates pinning by setting enabled to false, disabling pinning in options, clearing buffer, pinableFeatures, and pinningFeatures, and resetting coldFeatures.
   */
  this.deactivate = function () {
    this.enabled = false;
    geoflo.options['pinning'].enable = false;
    this.resetFeatures();
    delete this.buffer;
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name getFeatures
   * @description Retrieves the features from the pinnedFeatures array in the context object.
   * @returns {Array} An array of features extracted from the pinnedFeatures array.
   */
  this.getFeatures = function () {
    return this.pinnedFeatures.map(function (feature) {
      return geoflo.Utilities.cloneDeep(feature);
    });
  };
  this.saveFeatures = function () {
    var features = this.pinnedFeatures.map(function (feature) {
      return geoflo.Utilities.cloneDeep(feature);
    });
    geoflo.addFeatures(features, true);
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
    return features;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name setBuffer
   * @description This function creates a buffer around the provided coordinates based on the pinning buffer option.
   * @param {Array<number>} coords - The coordinates [longitude, latitude] to create the buffer around.
   * @returns {Object|boolean} Returns the buffer object containing the feature, radius, and coordinates if successful, otherwise false.
   */
  this.setBuffer = function (coords) {
    delete this.buffer;
    if (!this.enabled) return false;
    if (!coords || !geoflo.options.pinning.buffer) return false;
    var buffer = turf.buffer(turf.point(coords), geoflo.options.pinning.buffer);
    var radius = turf.polygon(buffer.geometry.coordinates);
    this.buffer = {
      feature: buffer,
      radius: radius,
      coords: coords
    };
    return this.buffer;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name setFeatures
   * @description Sets the pinable features based on the provided coordinates and fires an event.
   * @param {Object} coords - The coordinates to determine nearby features.
   * @returns {Array} - An array of pinable features.
   */
  this.setFeatures = function (coords) {
    if (!this.enabled || !coords) return false;
    this.pinableFeatures = this.getNearByFeatures(coords);
    geoflo.fire('pinning.add', {
      features: this.pinableFeatures,
      buffer: this.buffer
    });
    return this.pinableFeatures;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name resetFeatures
   * @description Resets the updated features by adding them to the canvas context.
   * @returns {boolean} Returns false if there are no updated features to reset.
   */
  this.resetFeatures = function () {
    if (!this.coldFeatures.length) return false;
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
    geoflo.addFeatures(this.coldFeatures, true);
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name updateFeatures
   * @description This function updates the features if the pinning functionality is enabled. It updates the pinable features, pinned features, and triggers events accordingly.
   * @returns {boolean} Returns false if the pinning functionality is not enabled, otherwise returns the updated pinning features.
   */
  this.updateFeatures = function (point) {
    if (!this.enabled || !point || !this.pinableFeatures.length) return false;
    updateFeatures.call(this, this.pinableFeatures, point.geometry.coordinates);
    geoflo.hideFeatures(this.coldFeatures.map(function (feature) {
      return feature.id;
    }));
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection(this.pinnedFeatures));
    geoflo.pinnedFeatures = geoflo.Utilities.cloneDeep(this.pinableFeatures);
    geoflo.fire('pinning.update', {
      feature: geoflo.hotFeature,
      point: point,
      pinned: this.pinnedFeatures
    });
    return this.pinnedFeatures;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name getNearByFeatures
   * @description This function calculates the radius based on the map zoom level and retrieves nearby features within that radius.
   * @param {Array<number>} coords - The coordinates [longitude, latitude] to find nearby features.
   * @returns {Array<Object>} An array of nearby features with their IDs, types, indices, and feature objects.
   */
  this.getNearByFeatures = function (coords) {
    if (!this.enabled || !coords) return false;
    var hotFeatureId = geoflo.hotFeature ? geoflo.hotFeature.id : null;
    var calculatedRadius = geoflo.options.snapping.distance * Math.pow(2, Math.max(1, 19 - geoflo.map.getZoom()));
    var radiusInKm = calculatedRadius / 100000;
    var buffer = this.setBuffer(coords);
    if (!buffer) return false;
    var features = geoflo.getRenderedDrawnFeatures({
      lng: coords[0],
      lat: coords[1]
    }, radiusInKm);
    var nearby = [];

    // Precompute point for faster comparisons
    var point = turf.point(coords);
    features.forEach(function (feature) {
      if (hotFeatureId === feature.id) return; // Skip if it's the active feature

      // Check all coordinates in one loop instead of using `turf.coordEach`
      var coordsArray = feature.geometry.coordinates.flat(Infinity); // Flattens to avoid nested looping

      for (var index = 0; index < coordsArray.length; index += 2) {
        var coord = [coordsArray[index], coordsArray[index + 1]];

        // Fast checks for nearby conditions
        if (buffer.radius && turf.booleanWithin(turf.point(coord), buffer.radius) || buffer.coords && geoflo.Utilities.isPointEqual(coord, buffer.coords)) {
          nearby.push({
            id: feature.id || feature.properties.id,
            type: feature.properties.type,
            index: Math.floor(index / 2),
            // Convert flattened index back to original index
            feature: feature
          });
          break; // Stop checking once a valid nearby point is found
        }
      }
    });
    return nearby;
  };
  if (geoflo.options['pinning'].enable) this.activate();
  function updateFeatures(features, coords) {
    var _this = this;
    if (!features || !features.length || !coords) return false;
    var coldFeatureIds = new Set(this.coldFeatures.map(function (f) {
      return f.id;
    }));
    var updatedFeatureIds = new Set(this.pinnedFeatures.map(function (f) {
      return f.id;
    }));
    features.forEach(function (feature) {
      var id = feature.id;
      var feat = feature.feature;
      var index = feature.index;
      if (!coldFeatureIds.has(id)) {
        _this.coldFeatures.push(geoflo.Utilities.cloneDeep(feat));
        coldFeatureIds.add(id);
      }
      var updated = updatedFeatureIds.has(id) ? _this.pinnedFeatures.find(function (f) {
        return f.id === id;
      }) : feat;
      if (updated.geometry.type === 'Point') {
        updated.geometry.coordinates = coords;
      } else if (updated.geometry.type === 'Polygon') {
        updated.geometry.coordinates[0][index] = coords;
      } else if (updated.geometry.type === 'LineString') {
        updated.geometry.coordinates[index] = coords;
      }
      if (!updatedFeatureIds.has(id)) {
        _this.pinnedFeatures.push(geoflo.Utilities.cloneDeep(updated));
        updatedFeatureIds.add(id);
      }
    });
  }
};
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (Pinning);

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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LENBQUNuRSxNQUFNLENBQUN1QixTQUFTLENBQUNDLFNBQVMsQ0FBQ3NELE9BQU8sQ0FBQyxDQUFDO1FBQzdESixpQkFBaUIsQ0FBQ0csR0FBRyxDQUFDbEMsRUFBRSxDQUFDO01BQzdCO0lBQ0osQ0FBQyxDQUFDO0VBQ047QUFFSixDQUFDO0FBRUQsaUVBQWU3QyxPQUFPIiwic291cmNlcyI6WyJ3ZWJwYWNrOi8vQHNvbHV0ZWdyYXRlL2dlb2Zsby8uL3NyYy9QaW5uaW5nLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQG1peGluXG4gKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsb1xuICogQG5hbWUgUGlubmluZ1xuICogQGRlc2NyaXB0aW9uIFRoaXMgbW9kdWxlIHByb3ZpZGVzIHRoZSBwaW5uaW5nIGZ1bmN0aW9uYWxpdHkgZm9yIHRoZSBHZW9mbG8gYXBwbGljYXRpb24uIEl0IGFsbG93cyB1c2VycyB0byBwaW4gZmVhdHVyZXMgdG8gdGhlIG1hcCBieSBjcmVhdGluZyBhIGJ1ZmZlciBhcm91bmQgdGhlIGZlYXR1cmUgYW5kIHNuYXBwaW5nIHRvIG5lYXJieSBmZWF0dXJlcy5cbiAqIEBwYXJhbSB7T2JqZWN0fSBtb2RlIC0gVGhlIG1vZGUgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHR5cGUgb2YgbW9kZS5cbiAqIEByZXR1cm5zIHtPYmplY3R9IFJldHVybnMgdGhlIFBpbm5pbmcgb2JqZWN0LlxuICovXG5jb25zdCBQaW5uaW5nID0gZnVuY3Rpb24gKG1vZGUpIHtcbiAgICBjb25zdCBnZW9mbG8gPSB0aGlzLmdlb2ZsbztcblxuICAgIHRoaXMudHlwZSA9IG1vZGUudHlwZTtcbiAgICB0aGlzLmNvbGRGZWF0dXJlcyA9IFtdO1xuICAgIHRoaXMucGluYWJsZUZlYXR1cmVzID0gW107XG4gICAgdGhpcy5waW5uZWRGZWF0dXJlcyA9IFtdO1xuXG5cdC8qKlxuXHQgKiBAZnVuY3Rpb25cbiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsby5QaW5uaW5nXG5cdCAqIEBuYW1lIGFjdGl2YXRlXG5cdCAqIEBkZXNjcmlwdGlvbiBBY3RpdmF0ZXMgdGhlIGZlYXR1cmUgYnkgc2V0dGluZyB0aGUgZW5hYmxlZCBmbGFnIHRvIHRydWUgYW5kIGVuYWJsaW5nIHBpbm5pbmcgaW4gdGhlIG9wdGlvbnMuXG5cdCAqIEBwYXJhbXMge3ZvaWR9IE5vbmVcblx0ICogQHJldHVybnMge3ZvaWR9XG5cdCAqL1xuICAgIC8qKlxuICAgICogQGZ1bmN0aW9uIGFjdGl2YXRlXG4gICAgKiBAbWVtYmVyb2YgX01FTUJFUl9PRl9cbiAgICAqIEBkZXNjcmlwdGlvbiAtIFRoaXMgZnVuY3Rpb24gYWN0aXZhdGVzIHRoZSBwaW5uaW5nIGZ1bmN0aW9uYWxpdHkgYnkgc2V0dGluZyB0aGUgZW5hYmxlZCBmbGFnIHRvIHRydWUgYW5kIGVuYWJsaW5nIHBpbm5pbmcgaW4gdGhlIG9wdGlvbnMuXG4gICAgKlxuICAgICogQHJldHVybnMge3ZvaWR9IE5vIHJldHVybiB2YWx1ZS5cbiAgICAqXG4gICAgKi9cbiAgICB0aGlzLmFjdGl2YXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmNvbGRGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbmFibGVGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbm5lZEZlYXR1cmVzID0gW107XG4gICAgICAgIHRoaXMuZW5hYmxlZCA9IHRydWU7XG4gICAgICAgIGdlb2Zsby5vcHRpb25zWydwaW5uaW5nJ10uZW5hYmxlID0gdHJ1ZTtcbiAgICAgICAgZ2VvZmxvLm1hcC5nZXRTb3VyY2UoZ2VvZmxvLnN0YXRpY3MuY29uc3RhbnRzLnNvdXJjZXMuUElOKS5zZXREYXRhKHR1cmYuZmVhdHVyZUNvbGxlY3Rpb24oW10pKTtcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgZGVhY3RpdmF0ZVxuXHQgKiBAZGVzY3JpcHRpb24gVGhpcyBmdW5jdGlvbiBkZWFjdGl2YXRlcyBwaW5uaW5nIGJ5IHNldHRpbmcgZW5hYmxlZCB0byBmYWxzZSwgZGlzYWJsaW5nIHBpbm5pbmcgaW4gb3B0aW9ucywgY2xlYXJpbmcgYnVmZmVyLCBwaW5hYmxlRmVhdHVyZXMsIGFuZCBwaW5uaW5nRmVhdHVyZXMsIGFuZCByZXNldHRpbmcgY29sZEZlYXR1cmVzLlxuXHQgKi9cbiAgICB0aGlzLmRlYWN0aXZhdGUgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMuZW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICBnZW9mbG8ub3B0aW9uc1sncGlubmluZyddLmVuYWJsZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnJlc2V0RmVhdHVyZXMoKTtcbiAgICAgICAgZGVsZXRlIHRoaXMuYnVmZmVyO1xuICAgICAgICB0aGlzLmNvbGRGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbmFibGVGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbm5lZEZlYXR1cmVzID0gW107XG4gICAgfVxuXG5cdC8qKlxuXHQgKiBAZnVuY3Rpb25cbiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsby5QaW5uaW5nXG5cdCAqIEBuYW1lIGdldEZlYXR1cmVzXG5cdCAqIEBkZXNjcmlwdGlvbiBSZXRyaWV2ZXMgdGhlIGZlYXR1cmVzIGZyb20gdGhlIHBpbm5lZEZlYXR1cmVzIGFycmF5IGluIHRoZSBjb250ZXh0IG9iamVjdC5cblx0ICogQHJldHVybnMge0FycmF5fSBBbiBhcnJheSBvZiBmZWF0dXJlcyBleHRyYWN0ZWQgZnJvbSB0aGUgcGlubmVkRmVhdHVyZXMgYXJyYXkuXG5cdCAqL1xuICAgIHRoaXMuZ2V0RmVhdHVyZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnBpbm5lZEZlYXR1cmVzLm1hcChmdW5jdGlvbiAoZmVhdHVyZSkgeyByZXR1cm4gZ2VvZmxvLlV0aWxpdGllcy5jbG9uZURlZXAoZmVhdHVyZSkgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5zYXZlRmVhdHVyZXMgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGNvbnN0IGZlYXR1cmVzID0gdGhpcy5waW5uZWRGZWF0dXJlcy5tYXAoZnVuY3Rpb24gKGZlYXR1cmUpIHsgcmV0dXJuIGdlb2Zsby5VdGlsaXRpZXMuY2xvbmVEZWVwKGZlYXR1cmUpIH0pO1xuICAgICAgICBnZW9mbG8uYWRkRmVhdHVyZXMoZmVhdHVyZXMsIHRydWUpO1xuICAgICAgICBnZW9mbG8ubWFwLmdldFNvdXJjZShnZW9mbG8uc3RhdGljcy5jb25zdGFudHMuc291cmNlcy5QSU4pLnNldERhdGEodHVyZi5mZWF0dXJlQ29sbGVjdGlvbihbXSkpO1xuICAgICAgICB0aGlzLmNvbGRGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbmFibGVGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLnBpbm5lZEZlYXR1cmVzID0gW107XG4gICAgICAgIHJldHVybiBmZWF0dXJlcztcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgc2V0QnVmZmVyXG5cdCAqIEBkZXNjcmlwdGlvbiBUaGlzIGZ1bmN0aW9uIGNyZWF0ZXMgYSBidWZmZXIgYXJvdW5kIHRoZSBwcm92aWRlZCBjb29yZGluYXRlcyBiYXNlZCBvbiB0aGUgcGlubmluZyBidWZmZXIgb3B0aW9uLlxuXHQgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGNvb3JkcyAtIFRoZSBjb29yZGluYXRlcyBbbG9uZ2l0dWRlLCBsYXRpdHVkZV0gdG8gY3JlYXRlIHRoZSBidWZmZXIgYXJvdW5kLlxuXHQgKiBAcmV0dXJucyB7T2JqZWN0fGJvb2xlYW59IFJldHVybnMgdGhlIGJ1ZmZlciBvYmplY3QgY29udGFpbmluZyB0aGUgZmVhdHVyZSwgcmFkaXVzLCBhbmQgY29vcmRpbmF0ZXMgaWYgc3VjY2Vzc2Z1bCwgb3RoZXJ3aXNlIGZhbHNlLlxuXHQgKi9cbiAgICB0aGlzLnNldEJ1ZmZlciA9IGZ1bmN0aW9uIChjb29yZHMpIHtcbiAgICAgICAgZGVsZXRlIHRoaXMuYnVmZmVyO1xuXG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmICghY29vcmRzIHx8ICFnZW9mbG8ub3B0aW9ucy5waW5uaW5nLmJ1ZmZlcikgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIHZhciBidWZmZXIgPSB0dXJmLmJ1ZmZlcih0dXJmLnBvaW50KGNvb3JkcyksIGdlb2Zsby5vcHRpb25zLnBpbm5pbmcuYnVmZmVyKTtcbiAgICAgICAgdmFyIHJhZGl1cyA9IHR1cmYucG9seWdvbihidWZmZXIuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuXG4gICAgICAgIHRoaXMuYnVmZmVyID0ge1xuICAgICAgICAgICAgZmVhdHVyZTogYnVmZmVyLFxuICAgICAgICAgICAgcmFkaXVzOiByYWRpdXMsXG4gICAgICAgICAgICBjb29yZHM6IGNvb3Jkc1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyO1xuICAgIH1cblxuXHQvKipcblx0ICogQGZ1bmN0aW9uXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG8uUGlubmluZ1xuXHQgKiBAbmFtZSBzZXRGZWF0dXJlc1xuXHQgKiBAZGVzY3JpcHRpb24gU2V0cyB0aGUgcGluYWJsZSBmZWF0dXJlcyBiYXNlZCBvbiB0aGUgcHJvdmlkZWQgY29vcmRpbmF0ZXMgYW5kIGZpcmVzIGFuIGV2ZW50LlxuXHQgKiBAcGFyYW0ge09iamVjdH0gY29vcmRzIC0gVGhlIGNvb3JkaW5hdGVzIHRvIGRldGVybWluZSBuZWFyYnkgZmVhdHVyZXMuXG5cdCAqIEByZXR1cm5zIHtBcnJheX0gLSBBbiBhcnJheSBvZiBwaW5hYmxlIGZlYXR1cmVzLlxuXHQgKi9cbiAgICB0aGlzLnNldEZlYXR1cmVzID0gZnVuY3Rpb24gKGNvb3Jkcykge1xuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhY29vcmRzKSByZXR1cm4gZmFsc2U7XG4gICAgICAgIHRoaXMucGluYWJsZUZlYXR1cmVzID0gdGhpcy5nZXROZWFyQnlGZWF0dXJlcyhjb29yZHMpO1xuICAgICAgICBnZW9mbG8uZmlyZSgncGlubmluZy5hZGQnLCB7IGZlYXR1cmVzOiB0aGlzLnBpbmFibGVGZWF0dXJlcywgYnVmZmVyOiB0aGlzLmJ1ZmZlciB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMucGluYWJsZUZlYXR1cmVzO1xuICAgIH1cblxuXHQvKipcblx0ICogQGZ1bmN0aW9uXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG8uUGlubmluZ1xuXHQgKiBAbmFtZSByZXNldEZlYXR1cmVzXG5cdCAqIEBkZXNjcmlwdGlvbiBSZXNldHMgdGhlIHVwZGF0ZWQgZmVhdHVyZXMgYnkgYWRkaW5nIHRoZW0gdG8gdGhlIGNhbnZhcyBjb250ZXh0LlxuXHQgKiBAcmV0dXJucyB7Ym9vbGVhbn0gUmV0dXJucyBmYWxzZSBpZiB0aGVyZSBhcmUgbm8gdXBkYXRlZCBmZWF0dXJlcyB0byByZXNldC5cblx0ICovXG4gICAgdGhpcy5yZXNldEZlYXR1cmVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAoIXRoaXMuY29sZEZlYXR1cmVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBnZW9mbG8ubWFwLmdldFNvdXJjZShnZW9mbG8uc3RhdGljcy5jb25zdGFudHMuc291cmNlcy5QSU4pLnNldERhdGEodHVyZi5mZWF0dXJlQ29sbGVjdGlvbihbXSkpO1xuICAgICAgICBnZW9mbG8uYWRkRmVhdHVyZXModGhpcy5jb2xkRmVhdHVyZXMsIHRydWUpO1xuICAgIH1cblxuXHQvKipcblx0ICogQGZ1bmN0aW9uXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG8uUGlubmluZ1xuXHQgKiBAbmFtZSB1cGRhdGVGZWF0dXJlc1xuXHQgKiBAZGVzY3JpcHRpb24gVGhpcyBmdW5jdGlvbiB1cGRhdGVzIHRoZSBmZWF0dXJlcyBpZiB0aGUgcGlubmluZyBmdW5jdGlvbmFsaXR5IGlzIGVuYWJsZWQuIEl0IHVwZGF0ZXMgdGhlIHBpbmFibGUgZmVhdHVyZXMsIHBpbm5lZCBmZWF0dXJlcywgYW5kIHRyaWdnZXJzIGV2ZW50cyBhY2NvcmRpbmdseS5cblx0ICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgZmFsc2UgaWYgdGhlIHBpbm5pbmcgZnVuY3Rpb25hbGl0eSBpcyBub3QgZW5hYmxlZCwgb3RoZXJ3aXNlIHJldHVybnMgdGhlIHVwZGF0ZWQgcGlubmluZyBmZWF0dXJlcy5cblx0ICovXG4gICAgdGhpcy51cGRhdGVGZWF0dXJlcyA9IGZ1bmN0aW9uIChwb2ludCkge1xuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhcG9pbnQgfHwgIXRoaXMucGluYWJsZUZlYXR1cmVzLmxlbmd0aCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICB1cGRhdGVGZWF0dXJlcy5jYWxsKHRoaXMsIHRoaXMucGluYWJsZUZlYXR1cmVzLCBwb2ludC5nZW9tZXRyeS5jb29yZGluYXRlcyk7XG4gICAgICAgIGdlb2Zsby5oaWRlRmVhdHVyZXModGhpcy5jb2xkRmVhdHVyZXMubWFwKGZ1bmN0aW9uIChmZWF0dXJlKSB7IHJldHVybiBmZWF0dXJlLmlkIH0pKTtcbiAgICAgICAgZ2VvZmxvLm1hcC5nZXRTb3VyY2UoZ2VvZmxvLnN0YXRpY3MuY29uc3RhbnRzLnNvdXJjZXMuUElOKS5zZXREYXRhKHR1cmYuZmVhdHVyZUNvbGxlY3Rpb24odGhpcy5waW5uZWRGZWF0dXJlcykpO1xuICAgICAgICBnZW9mbG8ucGlubmVkRmVhdHVyZXMgPSBnZW9mbG8uVXRpbGl0aWVzLmNsb25lRGVlcCh0aGlzLnBpbmFibGVGZWF0dXJlcyk7XG4gICAgICAgIGdlb2Zsby5maXJlKCdwaW5uaW5nLnVwZGF0ZScsIHsgZmVhdHVyZTogZ2VvZmxvLmhvdEZlYXR1cmUsIHBvaW50OiBwb2ludCwgcGlubmVkOiB0aGlzLnBpbm5lZEZlYXR1cmVzIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy5waW5uZWRGZWF0dXJlcztcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgZ2V0TmVhckJ5RmVhdHVyZXNcblx0ICogQGRlc2NyaXB0aW9uIFRoaXMgZnVuY3Rpb24gY2FsY3VsYXRlcyB0aGUgcmFkaXVzIGJhc2VkIG9uIHRoZSBtYXAgem9vbSBsZXZlbCBhbmQgcmV0cmlldmVzIG5lYXJieSBmZWF0dXJlcyB3aXRoaW4gdGhhdCByYWRpdXMuXG5cdCAqIEBwYXJhbSB7QXJyYXk8bnVtYmVyPn0gY29vcmRzIC0gVGhlIGNvb3JkaW5hdGVzIFtsb25naXR1ZGUsIGxhdGl0dWRlXSB0byBmaW5kIG5lYXJieSBmZWF0dXJlcy5cblx0ICogQHJldHVybnMge0FycmF5PE9iamVjdD59IEFuIGFycmF5IG9mIG5lYXJieSBmZWF0dXJlcyB3aXRoIHRoZWlyIElEcywgdHlwZXMsIGluZGljZXMsIGFuZCBmZWF0dXJlIG9iamVjdHMuXG5cdCAqL1xuICAgIHRoaXMuZ2V0TmVhckJ5RmVhdHVyZXMgPSBmdW5jdGlvbiAoY29vcmRzKSB7XG4gICAgICAgIGlmICghdGhpcy5lbmFibGVkIHx8ICFjb29yZHMpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBjb25zdCBob3RGZWF0dXJlSWQgPSBnZW9mbG8uaG90RmVhdHVyZSA/IGdlb2Zsby5ob3RGZWF0dXJlLmlkIDogbnVsbDtcbiAgICAgICAgY29uc3QgY2FsY3VsYXRlZFJhZGl1cyA9IGdlb2Zsby5vcHRpb25zLnNuYXBwaW5nLmRpc3RhbmNlICogTWF0aC5wb3coMiwgTWF0aC5tYXgoMSwgMTkgLSBnZW9mbG8ubWFwLmdldFpvb20oKSkpO1xuICAgICAgICBjb25zdCByYWRpdXNJbkttID0gY2FsY3VsYXRlZFJhZGl1cyAvIDEwMDAwMDtcbiAgICAgICAgY29uc3QgYnVmZmVyID0gdGhpcy5zZXRCdWZmZXIoY29vcmRzKTtcblxuICAgICAgICBpZiAoIWJ1ZmZlcikgcmV0dXJuIGZhbHNlO1xuXG4gICAgICAgIGNvbnN0IGZlYXR1cmVzID0gZ2VvZmxvLmdldFJlbmRlcmVkRHJhd25GZWF0dXJlcyh7IGxuZzogY29vcmRzWzBdLCBsYXQ6IGNvb3Jkc1sxXSB9LCByYWRpdXNJbkttKTtcbiAgICAgICAgY29uc3QgbmVhcmJ5ID0gW107XG5cbiAgICAgICAgLy8gUHJlY29tcHV0ZSBwb2ludCBmb3IgZmFzdGVyIGNvbXBhcmlzb25zXG4gICAgICAgIGNvbnN0IHBvaW50ID0gdHVyZi5wb2ludChjb29yZHMpO1xuXG4gICAgICAgIGZlYXR1cmVzLmZvckVhY2goKGZlYXR1cmUpID0+IHtcbiAgICAgICAgICAgIGlmIChob3RGZWF0dXJlSWQgPT09IGZlYXR1cmUuaWQpIHJldHVybjsgLy8gU2tpcCBpZiBpdCdzIHRoZSBhY3RpdmUgZmVhdHVyZVxuXG4gICAgICAgICAgICAvLyBDaGVjayBhbGwgY29vcmRpbmF0ZXMgaW4gb25lIGxvb3AgaW5zdGVhZCBvZiB1c2luZyBgdHVyZi5jb29yZEVhY2hgXG4gICAgICAgICAgICBjb25zdCBjb29yZHNBcnJheSA9IGZlYXR1cmUuZ2VvbWV0cnkuY29vcmRpbmF0ZXMuZmxhdChJbmZpbml0eSk7IC8vIEZsYXR0ZW5zIHRvIGF2b2lkIG5lc3RlZCBsb29waW5nXG5cbiAgICAgICAgICAgIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggPCBjb29yZHNBcnJheS5sZW5ndGg7IGluZGV4ICs9IDIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb29yZCA9IFtjb29yZHNBcnJheVtpbmRleF0sIGNvb3Jkc0FycmF5W2luZGV4ICsgMV1dO1xuXG4gICAgICAgICAgICAgICAgLy8gRmFzdCBjaGVja3MgZm9yIG5lYXJieSBjb25kaXRpb25zXG4gICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICAoYnVmZmVyLnJhZGl1cyAmJiB0dXJmLmJvb2xlYW5XaXRoaW4odHVyZi5wb2ludChjb29yZCksIGJ1ZmZlci5yYWRpdXMpKSB8fFxuICAgICAgICAgICAgICAgICAgICAoYnVmZmVyLmNvb3JkcyAmJiBnZW9mbG8uVXRpbGl0aWVzLmlzUG9pbnRFcXVhbChjb29yZCwgYnVmZmVyLmNvb3JkcykpXG4gICAgICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgICAgIG5lYXJieS5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBmZWF0dXJlLmlkIHx8IGZlYXR1cmUucHJvcGVydGllcy5pZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IGZlYXR1cmUucHJvcGVydGllcy50eXBlLFxuICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IE1hdGguZmxvb3IoaW5kZXggLyAyKSwgLy8gQ29udmVydCBmbGF0dGVuZWQgaW5kZXggYmFjayB0byBvcmlnaW5hbCBpbmRleFxuICAgICAgICAgICAgICAgICAgICAgICAgZmVhdHVyZTogZmVhdHVyZVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7IC8vIFN0b3AgY2hlY2tpbmcgb25jZSBhIHZhbGlkIG5lYXJieSBwb2ludCBpcyBmb3VuZFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIG5lYXJieTtcbiAgICB9O1xuXG4gICAgXG4gICAgaWYgKGdlb2Zsby5vcHRpb25zWydwaW5uaW5nJ10uZW5hYmxlKSB0aGlzLmFjdGl2YXRlKCk7XG5cblxuICAgIGZ1bmN0aW9uIHVwZGF0ZUZlYXR1cmVzKGZlYXR1cmVzLCBjb29yZHMpIHtcbiAgICAgICAgaWYgKCFmZWF0dXJlcyB8fCAhZmVhdHVyZXMubGVuZ3RoIHx8ICFjb29yZHMpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBjb25zdCBjb2xkRmVhdHVyZUlkcyA9IG5ldyBTZXQodGhpcy5jb2xkRmVhdHVyZXMubWFwKGYgPT4gZi5pZCkpO1xuICAgICAgICBjb25zdCB1cGRhdGVkRmVhdHVyZUlkcyA9IG5ldyBTZXQodGhpcy5waW5uZWRGZWF0dXJlcy5tYXAoZiA9PiBmLmlkKSk7XG5cbiAgICAgICAgZmVhdHVyZXMuZm9yRWFjaCgoZmVhdHVyZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgaWQgPSBmZWF0dXJlLmlkO1xuICAgICAgICAgICAgY29uc3QgZmVhdCA9IGZlYXR1cmUuZmVhdHVyZTtcbiAgICAgICAgICAgIGNvbnN0IGluZGV4ID0gZmVhdHVyZS5pbmRleDtcblxuICAgICAgICAgICAgaWYgKCFjb2xkRmVhdHVyZUlkcy5oYXMoaWQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5jb2xkRmVhdHVyZXMucHVzaChnZW9mbG8uVXRpbGl0aWVzLmNsb25lRGVlcChmZWF0KSk7XG4gICAgICAgICAgICAgICAgY29sZEZlYXR1cmVJZHMuYWRkKGlkKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdXBkYXRlZCA9IHVwZGF0ZWRGZWF0dXJlSWRzLmhhcyhpZCkgPyB0aGlzLnBpbm5lZEZlYXR1cmVzLmZpbmQoZiA9PiBmLmlkID09PSBpZCkgOiBmZWF0O1xuXG4gICAgICAgICAgICBpZiAodXBkYXRlZC5nZW9tZXRyeS50eXBlID09PSAnUG9pbnQnKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlZC5nZW9tZXRyeS5jb29yZGluYXRlcyA9IGNvb3JkcztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlZC5nZW9tZXRyeS50eXBlID09PSAnUG9seWdvbicpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVkLmdlb21ldHJ5LmNvb3JkaW5hdGVzWzBdW2luZGV4XSA9IGNvb3JkcztcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodXBkYXRlZC5nZW9tZXRyeS50eXBlID09PSAnTGluZVN0cmluZycpIHtcbiAgICAgICAgICAgICAgICB1cGRhdGVkLmdlb21ldHJ5LmNvb3JkaW5hdGVzW2luZGV4XSA9IGNvb3JkcztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCF1cGRhdGVkRmVhdHVyZUlkcy5oYXMoaWQpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5waW5uZWRGZWF0dXJlcy5wdXNoKGdlb2Zsby5VdGlsaXRpZXMuY2xvbmVEZWVwKHVwZGF0ZWQpKTtcbiAgICAgICAgICAgICAgICB1cGRhdGVkRmVhdHVyZUlkcy5hZGQoaWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbn07XG5cbmV4cG9ydCBkZWZhdWx0IFBpbm5pbmc7Il0sIm5hbWVzIjpbIlBpbm5pbmciLCJtb2RlIiwiZ2VvZmxvIiwidHlwZSIsImNvbGRGZWF0dXJlcyIsInBpbmFibGVGZWF0dXJlcyIsInBpbm5lZEZlYXR1cmVzIiwiYWN0aXZhdGUiLCJlbmFibGVkIiwib3B0aW9ucyIsImVuYWJsZSIsIm1hcCIsImdldFNvdXJjZSIsInN0YXRpY3MiLCJjb25zdGFudHMiLCJzb3VyY2VzIiwiUElOIiwic2V0RGF0YSIsInR1cmYiLCJmZWF0dXJlQ29sbGVjdGlvbiIsImRlYWN0aXZhdGUiLCJyZXNldEZlYXR1cmVzIiwiYnVmZmVyIiwiZ2V0RmVhdHVyZXMiLCJmZWF0dXJlIiwiVXRpbGl0aWVzIiwiY2xvbmVEZWVwIiwic2F2ZUZlYXR1cmVzIiwiZmVhdHVyZXMiLCJhZGRGZWF0dXJlcyIsInNldEJ1ZmZlciIsImNvb3JkcyIsInBpbm5pbmciLCJwb2ludCIsInJhZGl1cyIsInBvbHlnb24iLCJnZW9tZXRyeSIsImNvb3JkaW5hdGVzIiwic2V0RmVhdHVyZXMiLCJnZXROZWFyQnlGZWF0dXJlcyIsImZpcmUiLCJsZW5ndGgiLCJ1cGRhdGVGZWF0dXJlcyIsImNhbGwiLCJoaWRlRmVhdHVyZXMiLCJpZCIsImhvdEZlYXR1cmUiLCJwaW5uZWQiLCJob3RGZWF0dXJlSWQiLCJjYWxjdWxhdGVkUmFkaXVzIiwic25hcHBpbmciLCJkaXN0YW5jZSIsIk1hdGgiLCJwb3ciLCJtYXgiLCJnZXRab29tIiwicmFkaXVzSW5LbSIsImdldFJlbmRlcmVkRHJhd25GZWF0dXJlcyIsImxuZyIsImxhdCIsIm5lYXJieSIsImZvckVhY2giLCJjb29yZHNBcnJheSIsImZsYXQiLCJJbmZpbml0eSIsImluZGV4IiwiY29vcmQiLCJib29sZWFuV2l0aGluIiwiaXNQb2ludEVxdWFsIiwicHVzaCIsInByb3BlcnRpZXMiLCJmbG9vciIsIl90aGlzIiwiY29sZEZlYXR1cmVJZHMiLCJTZXQiLCJmIiwidXBkYXRlZEZlYXR1cmVJZHMiLCJmZWF0IiwiaGFzIiwiYWRkIiwidXBkYXRlZCIsImZpbmQiXSwic291cmNlUm9vdCI6IiJ9