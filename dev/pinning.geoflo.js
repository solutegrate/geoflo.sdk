/*!
 * /*!
 *  * GeoFlo SDK
 *  * Version 1.1.7
 *  * Generated on: 2025-02-07T04:21:01.113Z
 *  * Copyright (c) 2022 - present | @solutegrate/geoflo
 *  * /
 */
"use strict";
(self["webpackChunk_solutegrate_geoflo"] = self["webpackChunk_solutegrate_geoflo"] || []).push([["pinning"],{

/***/ "./src/Pinning.js":
/*!************************!*\
  !*** ./src/Pinning.js ***!
  \************************/
/***/ ((__unused_webpack_module, __webpack_exports__, __webpack_require__) => {

__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "default": () => (__WEBPACK_DEFAULT_EXPORT__)
/* harmony export */ });
/**
 * @mixin
 * @memberof module:geoflo
 * @name Pinning
 * @description This module provides the pinning functionality for the Geoflo application. It allows users to pin features to the map by creating a buffer around the feature and snapping to nearby features.
 * @param {Object} mode - The mode object containing the type of mode.
 * @returns {Object} Returns the Pinning object.
 */
var Pinning = function Pinning(mode) {
  var geoflo = this.geoflo;
  this.type = mode.type;
  this.coldFeatures = [];
  this.pinableFeatures = [];
  this.pinnedFeatures = [];

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name activate
   * @description Activates the feature by setting the enabled flag to true and enabling pinning in the options.
   * @params {void} None
   * @returns {void}
   */
  /**
  * @function activate
  * @memberof _MEMBER_OF_
  * @description - This function activates the pinning functionality by setting the enabled flag to true and enabling pinning in the options.
  *
  * @returns {void} No return value.
  *
  */
  this.activate = function () {
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
    this.enabled = true;
    geoflo.options['pinning'].enable = true;
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name deactivate
   * @description This function deactivates pinning by setting enabled to false, disabling pinning in options, clearing buffer, pinableFeatures, and pinningFeatures, and resetting coldFeatures.
   */
  this.deactivate = function () {
    this.enabled = false;
    geoflo.options['pinning'].enable = false;
    this.resetFeatures();
    delete this.buffer;
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name getFeatures
   * @description Retrieves the features from the pinnedFeatures array in the context object.
   * @returns {Array} An array of features extracted from the pinnedFeatures array.
   */
  this.getFeatures = function () {
    return this.pinnedFeatures.map(function (feature) {
      return geoflo.Utilities.cloneDeep(feature);
    });
  };
  this.saveFeatures = function () {
    var features = this.pinnedFeatures.map(function (feature) {
      return geoflo.Utilities.cloneDeep(feature);
    });
    geoflo.addFeatures(features, true);
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
    this.coldFeatures = [];
    this.pinableFeatures = [];
    this.pinnedFeatures = [];
    return features;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name setBuffer
   * @description This function creates a buffer around the provided coordinates based on the pinning buffer option.
   * @param {Array<number>} coords - The coordinates [longitude, latitude] to create the buffer around.
   * @returns {Object|boolean} Returns the buffer object containing the feature, radius, and coordinates if successful, otherwise false.
   */
  this.setBuffer = function (coords) {
    delete this.buffer;
    if (!this.enabled) return false;
    if (!coords || !geoflo.options.pinning.buffer) return false;
    var buffer = turf.buffer(turf.point(coords), geoflo.options.pinning.buffer);
    var radius = turf.polygon(buffer.geometry.coordinates);
    this.buffer = {
      feature: buffer,
      radius: radius,
      coords: coords
    };
    return this.buffer;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name setFeatures
   * @description Sets the pinable features based on the provided coordinates and fires an event.
   * @param {Object} coords - The coordinates to determine nearby features.
   * @returns {Array} - An array of pinable features.
   */
  this.setFeatures = function (coords) {
    if (!this.enabled || !coords) return false;
    this.pinableFeatures = this.getNearByFeatures(coords);
    geoflo.fire('pinning.add', {
      features: this.pinableFeatures,
      buffer: this.buffer
    });
    return this.pinableFeatures;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name resetFeatures
   * @description Resets the updated features by adding them to the canvas context.
   * @returns {boolean} Returns false if there are no updated features to reset.
   */
  this.resetFeatures = function () {
    if (!this.coldFeatures.length) return false;
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection([]));
    geoflo.addFeatures(this.coldFeatures, true);
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name updateFeatures
   * @description This function updates the features if the pinning functionality is enabled. It updates the pinable features, pinned features, and triggers events accordingly.
   * @returns {boolean} Returns false if the pinning functionality is not enabled, otherwise returns the updated pinning features.
   */
  this.updateFeatures = function (point) {
    if (!this.enabled || !point || !this.pinableFeatures.length) return false;
    updateFeatures.call(this, this.pinableFeatures, point.geometry.coordinates);
    geoflo.hideFeatures(this.coldFeatures.map(function (feature) {
      return feature.id;
    }));
    geoflo.map.getSource(geoflo.statics.constants.sources.PIN).setData(turf.featureCollection(this.pinnedFeatures));
    geoflo.pinnedFeatures = geoflo.Utilities.cloneDeep(this.pinableFeatures);
    geoflo.fire('pinning.update', {
      feature: geoflo.hotFeature,
      point: point,
      pinned: this.pinnedFeatures
    });
    return this.pinnedFeatures;
  };

  /**
   * @function
      * @memberof module:geoflo.Pinning
   * @name getNearByFeatures
   * @description This function calculates the radius based on the map zoom level and retrieves nearby features within that radius.
   * @param {Array<number>} coords - The coordinates [longitude, latitude] to find nearby features.
   * @returns {Array<Object>} An array of nearby features with their IDs, types, indices, and feature objects.
   */
  this.getNearByFeatures = function (coords) {
    if (!this.enabled || !coords) return false;
    var hotFeatureId = geoflo.hotFeature ? geoflo.hotFeature.id : null;
    var calculatedRadius = geoflo.options.snapping.distance * Math.pow(2, Math.max(1, 19 - geoflo.map.getZoom()));
    var radiusInKm = calculatedRadius / 100000;
    var buffer = this.setBuffer(coords);
    if (!buffer) return false;
    var features = geoflo.getRenderedDrawnFeatures({
      lng: coords[0],
      lat: coords[1]
    }, radiusInKm);
    var nearby = [];

    // Precompute point for faster comparisons
    var point = turf.point(coords);
    features.forEach(function (feature) {
      if (hotFeatureId === feature.id) return; // Skip if it's the active feature

      // Check all coordinates in one loop instead of using `turf.coordEach`
      var coordsArray = feature.geometry.coordinates.flat(Infinity); // Flattens to avoid nested looping

      for (var index = 0; index < coordsArray.length; index += 2) {
        var coord = [coordsArray[index], coordsArray[index + 1]];

        // Fast checks for nearby conditions
        if (buffer.radius && turf.booleanWithin(turf.point(coord), buffer.radius) || buffer.coords && geoflo.Utilities.isPointEqual(coord, buffer.coords)) {
          nearby.push({
            id: feature.id || feature.properties.id,
            type: feature.properties.type,
            index: Math.floor(index / 2),
            // Convert flattened index back to original index
            feature: feature
          });
          break; // Stop checking once a valid nearby point is found
        }
      }
    });
    return nearby;
  };
  if (geoflo.options['pinning'].enable) this.activate();
  function updateFeatures(features, coords) {
    var _this = this;
    if (!features || !features.length || !coords) return false;
    var coldFeatureIds = new Set(this.coldFeatures.map(function (f) {
      return f.id;
    }));
    var updatedFeatureIds = new Set(this.pinnedFeatures.map(function (f) {
      return f.id;
    }));
    features.forEach(function (feature) {
      var id = feature.id;
      var feat = feature.feature;
      var index = feature.index;
      if (!coldFeatureIds.has(id)) {
        _this.coldFeatures.push(geoflo.Utilities.cloneDeep(feat));
        coldFeatureIds.add(id);
      }
      var updated = updatedFeatureIds.has(id) ? _this.pinnedFeatures.find(function (f) {
        return f.id === id;
      }) : feat;
      if (updated.geometry.type === 'Point') {
        updated.geometry.coordinates = coords;
      } else if (updated.geometry.type === 'Polygon') {
        updated.geometry.coordinates[0][index] = coords;
      } else if (updated.geometry.type === 'LineString') {
        updated.geometry.coordinates[index] = coords;
      }
      if (!updatedFeatureIds.has(id)) {
        _this.pinnedFeatures.push(geoflo.Utilities.cloneDeep(updated));
        updatedFeatureIds.add(id);
      }
    });
  }
};
/* harmony default export */ const __WEBPACK_DEFAULT_EXPORT__ = (Pinning);

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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SSxDQUFDbkUsTUFBTSxDQUFDdUIsU0FBUyxDQUFDQyxTQUFTLENBQUNzRCxPQUFPLENBQUMsQ0FBQztRQUM3REosaUJBQWlCLENBQUNHLEdBQUcsQ0FBQ2xDLEVBQUUsQ0FBQztNQUM3QjtJQUNKLENBQUMsQ0FBQztFQUNOO0FBRUosQ0FBQztBQUVELGlFQUFlN0MsT0FBTyIsInNvdXJjZXMiOlsid2VicGFjazovL0Bzb2x1dGVncmF0ZS9nZW9mbG8vLi9zcmMvUGlubmluZy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBtaXhpblxuICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG9cbiAqIEBuYW1lIFBpbm5pbmdcbiAqIEBkZXNjcmlwdGlvbiBUaGlzIG1vZHVsZSBwcm92aWRlcyB0aGUgcGlubmluZyBmdW5jdGlvbmFsaXR5IGZvciB0aGUgR2VvZmxvIGFwcGxpY2F0aW9uLiBJdCBhbGxvd3MgdXNlcnMgdG8gcGluIGZlYXR1cmVzIHRvIHRoZSBtYXAgYnkgY3JlYXRpbmcgYSBidWZmZXIgYXJvdW5kIHRoZSBmZWF0dXJlIGFuZCBzbmFwcGluZyB0byBuZWFyYnkgZmVhdHVyZXMuXG4gKiBAcGFyYW0ge09iamVjdH0gbW9kZSAtIFRoZSBtb2RlIG9iamVjdCBjb250YWluaW5nIHRoZSB0eXBlIG9mIG1vZGUuXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBSZXR1cm5zIHRoZSBQaW5uaW5nIG9iamVjdC5cbiAqL1xuY29uc3QgUGlubmluZyA9IGZ1bmN0aW9uIChtb2RlKSB7XG4gICAgY29uc3QgZ2VvZmxvID0gdGhpcy5nZW9mbG87XG5cbiAgICB0aGlzLnR5cGUgPSBtb2RlLnR5cGU7XG4gICAgdGhpcy5jb2xkRmVhdHVyZXMgPSBbXTtcbiAgICB0aGlzLnBpbmFibGVGZWF0dXJlcyA9IFtdO1xuICAgIHRoaXMucGlubmVkRmVhdHVyZXMgPSBbXTtcblxuXHQvKipcblx0ICogQGZ1bmN0aW9uXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG8uUGlubmluZ1xuXHQgKiBAbmFtZSBhY3RpdmF0ZVxuXHQgKiBAZGVzY3JpcHRpb24gQWN0aXZhdGVzIHRoZSBmZWF0dXJlIGJ5IHNldHRpbmcgdGhlIGVuYWJsZWQgZmxhZyB0byB0cnVlIGFuZCBlbmFibGluZyBwaW5uaW5nIGluIHRoZSBvcHRpb25zLlxuXHQgKiBAcGFyYW1zIHt2b2lkfSBOb25lXG5cdCAqIEByZXR1cm5zIHt2b2lkfVxuXHQgKi9cbiAgICAvKipcbiAgICAqIEBmdW5jdGlvbiBhY3RpdmF0ZVxuICAgICogQG1lbWJlcm9mIF9NRU1CRVJfT0ZfXG4gICAgKiBAZGVzY3JpcHRpb24gLSBUaGlzIGZ1bmN0aW9uIGFjdGl2YXRlcyB0aGUgcGlubmluZyBmdW5jdGlvbmFsaXR5IGJ5IHNldHRpbmcgdGhlIGVuYWJsZWQgZmxhZyB0byB0cnVlIGFuZCBlbmFibGluZyBwaW5uaW5nIGluIHRoZSBvcHRpb25zLlxuICAgICpcbiAgICAqIEByZXR1cm5zIHt2b2lkfSBObyByZXR1cm4gdmFsdWUuXG4gICAgKlxuICAgICovXG4gICAgdGhpcy5hY3RpdmF0ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5jb2xkRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5hYmxlRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5uZWRGZWF0dXJlcyA9IFtdO1xuICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xuICAgICAgICBnZW9mbG8ub3B0aW9uc1sncGlubmluZyddLmVuYWJsZSA9IHRydWU7XG4gICAgICAgIGdlb2Zsby5tYXAuZ2V0U291cmNlKGdlb2Zsby5zdGF0aWNzLmNvbnN0YW50cy5zb3VyY2VzLlBJTikuc2V0RGF0YSh0dXJmLmZlYXR1cmVDb2xsZWN0aW9uKFtdKSk7XG4gICAgfVxuXG5cdC8qKlxuXHQgKiBAZnVuY3Rpb25cbiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsby5QaW5uaW5nXG5cdCAqIEBuYW1lIGRlYWN0aXZhdGVcblx0ICogQGRlc2NyaXB0aW9uIFRoaXMgZnVuY3Rpb24gZGVhY3RpdmF0ZXMgcGlubmluZyBieSBzZXR0aW5nIGVuYWJsZWQgdG8gZmFsc2UsIGRpc2FibGluZyBwaW5uaW5nIGluIG9wdGlvbnMsIGNsZWFyaW5nIGJ1ZmZlciwgcGluYWJsZUZlYXR1cmVzLCBhbmQgcGlubmluZ0ZlYXR1cmVzLCBhbmQgcmVzZXR0aW5nIGNvbGRGZWF0dXJlcy5cblx0ICovXG4gICAgdGhpcy5kZWFjdGl2YXRlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmVuYWJsZWQgPSBmYWxzZTtcbiAgICAgICAgZ2VvZmxvLm9wdGlvbnNbJ3Bpbm5pbmcnXS5lbmFibGUgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5yZXNldEZlYXR1cmVzKCk7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmJ1ZmZlcjtcbiAgICAgICAgdGhpcy5jb2xkRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5hYmxlRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5uZWRGZWF0dXJlcyA9IFtdO1xuICAgIH1cblxuXHQvKipcblx0ICogQGZ1bmN0aW9uXG4gICAgICogQG1lbWJlcm9mIG1vZHVsZTpnZW9mbG8uUGlubmluZ1xuXHQgKiBAbmFtZSBnZXRGZWF0dXJlc1xuXHQgKiBAZGVzY3JpcHRpb24gUmV0cmlldmVzIHRoZSBmZWF0dXJlcyBmcm9tIHRoZSBwaW5uZWRGZWF0dXJlcyBhcnJheSBpbiB0aGUgY29udGV4dCBvYmplY3QuXG5cdCAqIEByZXR1cm5zIHtBcnJheX0gQW4gYXJyYXkgb2YgZmVhdHVyZXMgZXh0cmFjdGVkIGZyb20gdGhlIHBpbm5lZEZlYXR1cmVzIGFycmF5LlxuXHQgKi9cbiAgICB0aGlzLmdldEZlYXR1cmVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5waW5uZWRGZWF0dXJlcy5tYXAoZnVuY3Rpb24gKGZlYXR1cmUpIHsgcmV0dXJuIGdlb2Zsby5VdGlsaXRpZXMuY2xvbmVEZWVwKGZlYXR1cmUpIH0pO1xuICAgIH1cblxuICAgIHRoaXMuc2F2ZUZlYXR1cmVzID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBjb25zdCBmZWF0dXJlcyA9IHRoaXMucGlubmVkRmVhdHVyZXMubWFwKGZ1bmN0aW9uIChmZWF0dXJlKSB7IHJldHVybiBnZW9mbG8uVXRpbGl0aWVzLmNsb25lRGVlcChmZWF0dXJlKSB9KTtcbiAgICAgICAgZ2VvZmxvLmFkZEZlYXR1cmVzKGZlYXR1cmVzLCB0cnVlKTtcbiAgICAgICAgZ2VvZmxvLm1hcC5nZXRTb3VyY2UoZ2VvZmxvLnN0YXRpY3MuY29uc3RhbnRzLnNvdXJjZXMuUElOKS5zZXREYXRhKHR1cmYuZmVhdHVyZUNvbGxlY3Rpb24oW10pKTtcbiAgICAgICAgdGhpcy5jb2xkRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5hYmxlRmVhdHVyZXMgPSBbXTtcbiAgICAgICAgdGhpcy5waW5uZWRGZWF0dXJlcyA9IFtdO1xuICAgICAgICByZXR1cm4gZmVhdHVyZXM7XG4gICAgfVxuXG5cdC8qKlxuXHQgKiBAZnVuY3Rpb25cbiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsby5QaW5uaW5nXG5cdCAqIEBuYW1lIHNldEJ1ZmZlclxuXHQgKiBAZGVzY3JpcHRpb24gVGhpcyBmdW5jdGlvbiBjcmVhdGVzIGEgYnVmZmVyIGFyb3VuZCB0aGUgcHJvdmlkZWQgY29vcmRpbmF0ZXMgYmFzZWQgb24gdGhlIHBpbm5pbmcgYnVmZmVyIG9wdGlvbi5cblx0ICogQHBhcmFtIHtBcnJheTxudW1iZXI+fSBjb29yZHMgLSBUaGUgY29vcmRpbmF0ZXMgW2xvbmdpdHVkZSwgbGF0aXR1ZGVdIHRvIGNyZWF0ZSB0aGUgYnVmZmVyIGFyb3VuZC5cblx0ICogQHJldHVybnMge09iamVjdHxib29sZWFufSBSZXR1cm5zIHRoZSBidWZmZXIgb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGZlYXR1cmUsIHJhZGl1cywgYW5kIGNvb3JkaW5hdGVzIGlmIHN1Y2Nlc3NmdWwsIG90aGVyd2lzZSBmYWxzZS5cblx0ICovXG4gICAgdGhpcy5zZXRCdWZmZXIgPSBmdW5jdGlvbiAoY29vcmRzKSB7XG4gICAgICAgIGRlbGV0ZSB0aGlzLmJ1ZmZlcjtcblxuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCkgcmV0dXJuIGZhbHNlO1xuICAgICAgICBpZiAoIWNvb3JkcyB8fCAhZ2VvZmxvLm9wdGlvbnMucGlubmluZy5idWZmZXIpIHJldHVybiBmYWxzZTtcblxuICAgICAgICB2YXIgYnVmZmVyID0gdHVyZi5idWZmZXIodHVyZi5wb2ludChjb29yZHMpLCBnZW9mbG8ub3B0aW9ucy5waW5uaW5nLmJ1ZmZlcik7XG4gICAgICAgIHZhciByYWRpdXMgPSB0dXJmLnBvbHlnb24oYnVmZmVyLmdlb21ldHJ5LmNvb3JkaW5hdGVzKTtcblxuICAgICAgICB0aGlzLmJ1ZmZlciA9IHtcbiAgICAgICAgICAgIGZlYXR1cmU6IGJ1ZmZlcixcbiAgICAgICAgICAgIHJhZGl1czogcmFkaXVzLFxuICAgICAgICAgICAgY29vcmRzOiBjb29yZHNcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlcjtcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgc2V0RmVhdHVyZXNcblx0ICogQGRlc2NyaXB0aW9uIFNldHMgdGhlIHBpbmFibGUgZmVhdHVyZXMgYmFzZWQgb24gdGhlIHByb3ZpZGVkIGNvb3JkaW5hdGVzIGFuZCBmaXJlcyBhbiBldmVudC5cblx0ICogQHBhcmFtIHtPYmplY3R9IGNvb3JkcyAtIFRoZSBjb29yZGluYXRlcyB0byBkZXRlcm1pbmUgbmVhcmJ5IGZlYXR1cmVzLlxuXHQgKiBAcmV0dXJucyB7QXJyYXl9IC0gQW4gYXJyYXkgb2YgcGluYWJsZSBmZWF0dXJlcy5cblx0ICovXG4gICAgdGhpcy5zZXRGZWF0dXJlcyA9IGZ1bmN0aW9uIChjb29yZHMpIHtcbiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIWNvb3JkcykgcmV0dXJuIGZhbHNlO1xuICAgICAgICB0aGlzLnBpbmFibGVGZWF0dXJlcyA9IHRoaXMuZ2V0TmVhckJ5RmVhdHVyZXMoY29vcmRzKTtcbiAgICAgICAgZ2VvZmxvLmZpcmUoJ3Bpbm5pbmcuYWRkJywgeyBmZWF0dXJlczogdGhpcy5waW5hYmxlRmVhdHVyZXMsIGJ1ZmZlcjogdGhpcy5idWZmZXIgfSk7XG4gICAgICAgIHJldHVybiB0aGlzLnBpbmFibGVGZWF0dXJlcztcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgcmVzZXRGZWF0dXJlc1xuXHQgKiBAZGVzY3JpcHRpb24gUmVzZXRzIHRoZSB1cGRhdGVkIGZlYXR1cmVzIGJ5IGFkZGluZyB0aGVtIHRvIHRoZSBjYW52YXMgY29udGV4dC5cblx0ICogQHJldHVybnMge2Jvb2xlYW59IFJldHVybnMgZmFsc2UgaWYgdGhlcmUgYXJlIG5vIHVwZGF0ZWQgZmVhdHVyZXMgdG8gcmVzZXQuXG5cdCAqL1xuICAgIHRoaXMucmVzZXRGZWF0dXJlcyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbGRGZWF0dXJlcy5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgICAgICAgZ2VvZmxvLm1hcC5nZXRTb3VyY2UoZ2VvZmxvLnN0YXRpY3MuY29uc3RhbnRzLnNvdXJjZXMuUElOKS5zZXREYXRhKHR1cmYuZmVhdHVyZUNvbGxlY3Rpb24oW10pKTtcbiAgICAgICAgZ2VvZmxvLmFkZEZlYXR1cmVzKHRoaXMuY29sZEZlYXR1cmVzLCB0cnVlKTtcbiAgICB9XG5cblx0LyoqXG5cdCAqIEBmdW5jdGlvblxuICAgICAqIEBtZW1iZXJvZiBtb2R1bGU6Z2VvZmxvLlBpbm5pbmdcblx0ICogQG5hbWUgdXBkYXRlRmVhdHVyZXNcblx0ICogQGRlc2NyaXB0aW9uIFRoaXMgZnVuY3Rpb24gdXBkYXRlcyB0aGUgZmVhdHVyZXMgaWYgdGhlIHBpbm5pbmcgZnVuY3Rpb25hbGl0eSBpcyBlbmFibGVkLiBJdCB1cGRhdGVzIHRoZSBwaW5hYmxlIGZlYXR1cmVzLCBwaW5uZWQgZmVhdHVyZXMsIGFuZCB0cmlnZ2VycyBldmVudHMgYWNjb3JkaW5nbHkuXG5cdCAqIEByZXR1cm5zIHtib29sZWFufSBSZXR1cm5zIGZhbHNlIGlmIHRoZSBwaW5uaW5nIGZ1bmN0aW9uYWxpdHkgaXMgbm90IGVuYWJsZWQsIG90aGVyd2lzZSByZXR1cm5zIHRoZSB1cGRhdGVkIHBpbm5pbmcgZmVhdHVyZXMuXG5cdCAqL1xuICAgIHRoaXMudXBkYXRlRmVhdHVyZXMgPSBmdW5jdGlvbiAocG9pbnQpIHtcbiAgICAgICAgaWYgKCF0aGlzLmVuYWJsZWQgfHwgIXBvaW50IHx8ICF0aGlzLnBpbmFibGVGZWF0dXJlcy5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgICAgICAgdXBkYXRlRmVhdHVyZXMuY2FsbCh0aGlzLCB0aGlzLnBpbmFibGVGZWF0dXJlcywgcG9pbnQuZ2VvbWV0cnkuY29vcmRpbmF0ZXMpO1xuICAgICAgICBnZW9mbG8uaGlkZUZlYXR1cmVzKHRoaXMuY29sZEZlYXR1cmVzLm1hcChmdW5jdGlvbiAoZmVhdHVyZSkgeyByZXR1cm4gZmVhdHVyZS5pZCB9KSk7XG4gICAgICAgIGdlb2Zsby5tYXAuZ2V0U291cmNlKGdlb2Zsby5zdGF0aWNzLmNvbnN0YW50cy5zb3VyY2VzLlBJTikuc2V0RGF0YSh0dXJmLmZlYXR1cmVDb2xsZWN0aW9uKHRoaXMucGlubmVkRmVhdHVyZXMpKTtcbiAgICAgICAgZ2VvZmxvLnBpbm5lZEZlYXR1cmVzID0gZ2VvZmxvLlV0aWxpdGllcy5jbG9uZURlZXAodGhpcy5waW5hYmxlRmVhdHVyZXMpO1xuICAgICAgICBnZW9mbG8uZmlyZSgncGlubmluZy51cGRhdGUnLCB7IGZlYXR1cmU6IGdlb2Zsby5ob3RGZWF0dXJlLCBwb2ludDogcG9pbnQsIHBpbm5lZDogdGhpcy5waW5uZWRGZWF0dXJlcyB9KTtcbiAgICAgICAgcmV0dXJuIHRoaXMucGlubmVkRmVhdHVyZXM7XG4gICAgfVxuXG5cdC8qKlxuXHQgKiBAZnVuY3Rpb25cbiAgICAgKiBAbWVtYmVyb2YgbW9kdWxlOmdlb2Zsby5QaW5uaW5nXG5cdCAqIEBuYW1lIGdldE5lYXJCeUZlYXR1cmVzXG5cdCAqIEBkZXNjcmlwdGlvbiBUaGlzIGZ1bmN0aW9uIGNhbGN1bGF0ZXMgdGhlIHJhZGl1cyBiYXNlZCBvbiB0aGUgbWFwIHpvb20gbGV2ZWwgYW5kIHJldHJpZXZlcyBuZWFyYnkgZmVhdHVyZXMgd2l0aGluIHRoYXQgcmFkaXVzLlxuXHQgKiBAcGFyYW0ge0FycmF5PG51bWJlcj59IGNvb3JkcyAtIFRoZSBjb29yZGluYXRlcyBbbG9uZ2l0dWRlLCBsYXRpdHVkZV0gdG8gZmluZCBuZWFyYnkgZmVhdHVyZXMuXG5cdCAqIEByZXR1cm5zIHtBcnJheTxPYmplY3Q+fSBBbiBhcnJheSBvZiBuZWFyYnkgZmVhdHVyZXMgd2l0aCB0aGVpciBJRHMsIHR5cGVzLCBpbmRpY2VzLCBhbmQgZmVhdHVyZSBvYmplY3RzLlxuXHQgKi9cbiAgICB0aGlzLmdldE5lYXJCeUZlYXR1cmVzID0gZnVuY3Rpb24gKGNvb3Jkcykge1xuICAgICAgICBpZiAoIXRoaXMuZW5hYmxlZCB8fCAhY29vcmRzKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgaG90RmVhdHVyZUlkID0gZ2VvZmxvLmhvdEZlYXR1cmUgPyBnZW9mbG8uaG90RmVhdHVyZS5pZCA6IG51bGw7XG4gICAgICAgIGNvbnN0IGNhbGN1bGF0ZWRSYWRpdXMgPSBnZW9mbG8ub3B0aW9ucy5zbmFwcGluZy5kaXN0YW5jZSAqIE1hdGgucG93KDIsIE1hdGgubWF4KDEsIDE5IC0gZ2VvZmxvLm1hcC5nZXRab29tKCkpKTtcbiAgICAgICAgY29uc3QgcmFkaXVzSW5LbSA9IGNhbGN1bGF0ZWRSYWRpdXMgLyAxMDAwMDA7XG4gICAgICAgIGNvbnN0IGJ1ZmZlciA9IHRoaXMuc2V0QnVmZmVyKGNvb3Jkcyk7XG5cbiAgICAgICAgaWYgKCFidWZmZXIpIHJldHVybiBmYWxzZTtcblxuICAgICAgICBjb25zdCBmZWF0dXJlcyA9IGdlb2Zsby5nZXRSZW5kZXJlZERyYXduRmVhdHVyZXMoeyBsbmc6IGNvb3Jkc1swXSwgbGF0OiBjb29yZHNbMV0gfSwgcmFkaXVzSW5LbSk7XG4gICAgICAgIGNvbnN0IG5lYXJieSA9IFtdO1xuXG4gICAgICAgIC8vIFByZWNvbXB1dGUgcG9pbnQgZm9yIGZhc3RlciBjb21wYXJpc29uc1xuICAgICAgICBjb25zdCBwb2ludCA9IHR1cmYucG9pbnQoY29vcmRzKTtcblxuICAgICAgICBmZWF0dXJlcy5mb3JFYWNoKChmZWF0dXJlKSA9PiB7XG4gICAgICAgICAgICBpZiAoaG90RmVhdHVyZUlkID09PSBmZWF0dXJlLmlkKSByZXR1cm47IC8vIFNraXAgaWYgaXQncyB0aGUgYWN0aXZlIGZlYXR1cmVcblxuICAgICAgICAgICAgLy8gQ2hlY2sgYWxsIGNvb3JkaW5hdGVzIGluIG9uZSBsb29wIGluc3RlYWQgb2YgdXNpbmcgYHR1cmYuY29vcmRFYWNoYFxuICAgICAgICAgICAgY29uc3QgY29vcmRzQXJyYXkgPSBmZWF0dXJlLmdlb21ldHJ5LmNvb3JkaW5hdGVzLmZsYXQoSW5maW5pdHkpOyAvLyBGbGF0dGVucyB0byBhdm9pZCBuZXN0ZWQgbG9vcGluZ1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgY29vcmRzQXJyYXkubGVuZ3RoOyBpbmRleCArPSAyKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29vcmQgPSBbY29vcmRzQXJyYXlbaW5kZXhdLCBjb29yZHNBcnJheVtpbmRleCArIDFdXTtcblxuICAgICAgICAgICAgICAgIC8vIEZhc3QgY2hlY2tzIGZvciBuZWFyYnkgY29uZGl0aW9uc1xuICAgICAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgICAgICAgKGJ1ZmZlci5yYWRpdXMgJiYgdHVyZi5ib29sZWFuV2l0aGluKHR1cmYucG9pbnQoY29vcmQpLCBidWZmZXIucmFkaXVzKSkgfHxcbiAgICAgICAgICAgICAgICAgICAgKGJ1ZmZlci5jb29yZHMgJiYgZ2VvZmxvLlV0aWxpdGllcy5pc1BvaW50RXF1YWwoY29vcmQsIGJ1ZmZlci5jb29yZHMpKVxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBuZWFyYnkucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZDogZmVhdHVyZS5pZCB8fCBmZWF0dXJlLnByb3BlcnRpZXMuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBmZWF0dXJlLnByb3BlcnRpZXMudHlwZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiBNYXRoLmZsb29yKGluZGV4IC8gMiksIC8vIENvbnZlcnQgZmxhdHRlbmVkIGluZGV4IGJhY2sgdG8gb3JpZ2luYWwgaW5kZXhcbiAgICAgICAgICAgICAgICAgICAgICAgIGZlYXR1cmU6IGZlYXR1cmVcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrOyAvLyBTdG9wIGNoZWNraW5nIG9uY2UgYSB2YWxpZCBuZWFyYnkgcG9pbnQgaXMgZm91bmRcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBuZWFyYnk7XG4gICAgfTtcblxuICAgIFxuICAgIGlmIChnZW9mbG8ub3B0aW9uc1sncGlubmluZyddLmVuYWJsZSkgdGhpcy5hY3RpdmF0ZSgpO1xuXG5cbiAgICBmdW5jdGlvbiB1cGRhdGVGZWF0dXJlcyhmZWF0dXJlcywgY29vcmRzKSB7XG4gICAgICAgIGlmICghZmVhdHVyZXMgfHwgIWZlYXR1cmVzLmxlbmd0aCB8fCAhY29vcmRzKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgY29uc3QgY29sZEZlYXR1cmVJZHMgPSBuZXcgU2V0KHRoaXMuY29sZEZlYXR1cmVzLm1hcChmID0+IGYuaWQpKTtcbiAgICAgICAgY29uc3QgdXBkYXRlZEZlYXR1cmVJZHMgPSBuZXcgU2V0KHRoaXMucGlubmVkRmVhdHVyZXMubWFwKGYgPT4gZi5pZCkpO1xuXG4gICAgICAgIGZlYXR1cmVzLmZvckVhY2goKGZlYXR1cmUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGlkID0gZmVhdHVyZS5pZDtcbiAgICAgICAgICAgIGNvbnN0IGZlYXQgPSBmZWF0dXJlLmZlYXR1cmU7XG4gICAgICAgICAgICBjb25zdCBpbmRleCA9IGZlYXR1cmUuaW5kZXg7XG5cbiAgICAgICAgICAgIGlmICghY29sZEZlYXR1cmVJZHMuaGFzKGlkKSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY29sZEZlYXR1cmVzLnB1c2goZ2VvZmxvLlV0aWxpdGllcy5jbG9uZURlZXAoZmVhdCkpO1xuICAgICAgICAgICAgICAgIGNvbGRGZWF0dXJlSWRzLmFkZChpZCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IHVwZGF0ZWQgPSB1cGRhdGVkRmVhdHVyZUlkcy5oYXMoaWQpID8gdGhpcy5waW5uZWRGZWF0dXJlcy5maW5kKGYgPT4gZi5pZCA9PT0gaWQpIDogZmVhdDtcblxuICAgICAgICAgICAgaWYgKHVwZGF0ZWQuZ2VvbWV0cnkudHlwZSA9PT0gJ1BvaW50Jykge1xuICAgICAgICAgICAgICAgIHVwZGF0ZWQuZ2VvbWV0cnkuY29vcmRpbmF0ZXMgPSBjb29yZHM7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWQuZ2VvbWV0cnkudHlwZSA9PT0gJ1BvbHlnb24nKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlZC5nZW9tZXRyeS5jb29yZGluYXRlc1swXVtpbmRleF0gPSBjb29yZHM7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHVwZGF0ZWQuZ2VvbWV0cnkudHlwZSA9PT0gJ0xpbmVTdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgdXBkYXRlZC5nZW9tZXRyeS5jb29yZGluYXRlc1tpbmRleF0gPSBjb29yZHM7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICghdXBkYXRlZEZlYXR1cmVJZHMuaGFzKGlkKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucGlubmVkRmVhdHVyZXMucHVzaChnZW9mbG8uVXRpbGl0aWVzLmNsb25lRGVlcCh1cGRhdGVkKSk7XG4gICAgICAgICAgICAgICAgdXBkYXRlZEZlYXR1cmVJZHMuYWRkKGlkKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG59O1xuXG5leHBvcnQgZGVmYXVsdCBQaW5uaW5nOyJdLCJuYW1lcyI6WyJQaW5uaW5nIiwibW9kZSIsImdlb2ZsbyIsInR5cGUiLCJjb2xkRmVhdHVyZXMiLCJwaW5hYmxlRmVhdHVyZXMiLCJwaW5uZWRGZWF0dXJlcyIsImFjdGl2YXRlIiwiZW5hYmxlZCIsIm9wdGlvbnMiLCJlbmFibGUiLCJtYXAiLCJnZXRTb3VyY2UiLCJzdGF0aWNzIiwiY29uc3RhbnRzIiwic291cmNlcyIsIlBJTiIsInNldERhdGEiLCJ0dXJmIiwiZmVhdHVyZUNvbGxlY3Rpb24iLCJkZWFjdGl2YXRlIiwicmVzZXRGZWF0dXJlcyIsImJ1ZmZlciIsImdldEZlYXR1cmVzIiwiZmVhdHVyZSIsIlV0aWxpdGllcyIsImNsb25lRGVlcCIsInNhdmVGZWF0dXJlcyIsImZlYXR1cmVzIiwiYWRkRmVhdHVyZXMiLCJzZXRCdWZmZXIiLCJjb29yZHMiLCJwaW5uaW5nIiwicG9pbnQiLCJyYWRpdXMiLCJwb2x5Z29uIiwiZ2VvbWV0cnkiLCJjb29yZGluYXRlcyIsInNldEZlYXR1cmVzIiwiZ2V0TmVhckJ5RmVhdHVyZXMiLCJmaXJlIiwibGVuZ3RoIiwidXBkYXRlRmVhdHVyZXMiLCJjYWxsIiwiaGlkZUZlYXR1cmVzIiwiaWQiLCJob3RGZWF0dXJlIiwicGlubmVkIiwiaG90RmVhdHVyZUlkIiwiY2FsY3VsYXRlZFJhZGl1cyIsInNuYXBwaW5nIiwiZGlzdGFuY2UiLCJNYXRoIiwicG93IiwibWF4IiwiZ2V0Wm9vbSIsInJhZGl1c0luS20iLCJnZXRSZW5kZXJlZERyYXduRmVhdHVyZXMiLCJsbmciLCJsYXQiLCJuZWFyYnkiLCJmb3JFYWNoIiwiY29vcmRzQXJyYXkiLCJmbGF0IiwiSW5maW5pdHkiLCJpbmRleCIsImNvb3JkIiwiYm9vbGVhbldpdGhpbiIsImlzUG9pbnRFcXVhbCIsInB1c2giLCJwcm9wZXJ0aWVzIiwiZmxvb3IiLCJfdGhpcyIsImNvbGRGZWF0dXJlSWRzIiwiU2V0IiwiZiIsInVwZGF0ZWRGZWF0dXJlSWRzIiwiZmVhdCIsImhhcyIsImFkZCIsInVwZGF0ZWQiLCJmaW5kIl0sInNvdXJjZVJvb3QiOiIifQ==